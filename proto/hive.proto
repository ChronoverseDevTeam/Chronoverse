syntax = "proto3";
package hive_proto;

message BonjourReq {}

message BonjourRsp {
    int32 majorVersion = 1;
    int32 minorVersion = 2;
    string apiImplementation = 3;
    string platform = 4;
    string os = 5;
    string architecture = 6;
}

// Auth Starts
message RegisterReq {
    string username = 1;
    string password = 2;
}

message RegisterRsp {
    bool success = 1;
    string message = 2;
}

message LoginReq {
    string username = 1;
    string password = 2;
}

message LoginRsp {
    string accessToken = 1;
    int64 expiresAt = 2;
}
// Auth End

// Submit Start
message UploadFileChunkReq {
    string ticket = 1;
    // 可支持同时上传多个 file chunk
    string chunk_hash = 2;
    int64 offset = 3;
    bytes content = 4;
    // 某个 file chunk 是否已经传输完毕
    bool eof = 5;
    // 本块使用的压缩方式，必须传入，目前可用字段是 "none" / "lz4"
    string compression = 6;
    // 解压后的原始大小（字节），用于校验
    uint32 uncompressed_size = 7;
}

message UploadFileChunkRsp {
    string ticket = 1;
    bool success = 2;
    string chunk_hash = 3;
    string message = 4;
    // 如果服务器端已经存在相同 chunk（基于 chunk_hash），则会返回 true
    bool already_exists = 5;
}

// 客户端可先询问服务器当前缺少哪些 chunk，从而只上传需要的部分
message CheckChunksReq {
    repeated string chunk_hashes = 1;
}

message CheckChunksRsp {
    // 服务器端当前不存在的 chunk_hash 列表
    repeated string missing_chunk_hashes = 1;
}

message FileChunks {
    // 文件 ID（通常为路径的 Blake3 哈希，对应 `files` 集合中的 `_id`）
    string file_id = 1;
    repeated string binary_id = 5;
}

message SubmitReq {
    string ticket = 1;
    string description = 2;
    repeated FileChunks files = 3;
}

message FileToLock {
    string file_id = 1;
    string path = 2;
    // 期望在锁定时文件的版本，只有在该文件在对应分支上被第一次创建时才能够为空，其他情况下为空应该视为错误
    string expected_file_revision = 3;
    // 若为 true，表示期望文件当前不存在
    bool expected_file_not_exist = 4;
    // 是否是删除目标文件的请求，在该项目设置为 true 时，expected_file_not_exists 应该为无效
    bool is_delete = 5;
}

message LaunchSubmitReq {
    // 要进行提交的分支，如果为空字符串则不具备分支
    string branch_id = 1;
    // 要锁定的文件
    repeated FileToLock files = 2;
}

message FileUnableToLock {
    string file_id = 1;
    string branch_id = 2;
    string path = 3;
    string current_file_revision = 4;
    string expected_file_revision = 5;
    bool expected_file_not_exist = 6;
}

message LaunchSubmitRsp {
    string ticket = 1;
    // 如果有任何文件无法被锁定则返回 false
    bool success = 2;
    repeated FileUnableToLock file_unable_to_lock = 3;
}

message SubmitConflict {
    string file_id = 1;
    string expected_file_revision = 2;
    string current_revision = 3;
}

message SubmitRsp {
    bool success = 1;
    // 如果成功，返回新建的 changelist ID 及提交时间
    int64 changelist_id = 2;
    int64 committed_at = 3;

    // 如果由于文件版本冲突导致提交失败，列出冲突详情
    repeated SubmitConflict conflicts = 4;

    // 如果在检查时发现任何文件包含的 chunk 尚未全部上传，也可以在这里返回其 chunk_id
    repeated string missing_chunks = 5;

    string message = 6;
    string uuid = 7;
}
// Submit End

message File {
    string name = 1;
    string file_id = 2;
    string revision_id = 3;
    string changelist_id = 4;
    repeated string binary_id = 5;
    int64 size = 6;
    int64 revision_created_at = 7;
}

message Directory {
    string name = 1;
    repeated FileTreeNode children = 2;
}

message FileTreeNode {
    oneof node {
        File file = 1;
        Directory directory = 2;
    }
}

message GetFileTreeReq {
    string branch_id = 1;
    string depot_wildcard = 2;
    int64 changelist_id = 3;
}

message GetFileTreeRsp {
    repeated FileTreeNode file_tree_root = 1;
}

message DownloadFileChunkReq {
    repeated string chunk_hashes = 1;
    int64 packetSize = 2; // 每个 stream 包的大小，单位 byte
}

message DownloadFileChunkResp {
    string chunk_hash = 1;
    int64 offset = 2;
    bytes content = 3;
    bool eof = 4;
    // 本块使用的压缩方式，可选，例如 "none" / "lz4"
    string compression = 5;
    // 解压后的原始大小（字节），用于校验
    uint32 uncompressed_size = 6;
}

service HiveService {
    rpc bonjour(BonjourReq) returns (BonjourRsp);

    rpc Login(LoginReq) returns (LoginRsp);
    rpc Register(RegisterReq) returns (RegisterRsp);

    rpc LaunchSubmit(LaunchSubmitReq) returns (LaunchSubmitRsp);
    rpc CheckChunks(CheckChunksReq) returns (CheckChunksRsp);
    rpc UploadFileChunk(stream UploadFileChunkReq) returns (stream UploadFileChunkRsp);
    rpc Submit(SubmitReq) returns (SubmitRsp);

    rpc GetFileTree(GetFileTreeReq) returns (GetFileTreeRsp);
    rpc DownloadFileChunk(DownloadFileChunkReq) returns (stream DownloadFileChunkResp);
}
