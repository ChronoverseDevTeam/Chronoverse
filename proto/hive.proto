syntax = "proto3";
package hive_proto;

message GreetingReq {
  string msg = 1;
}

message NilRsp {
}

message UpsertWorkspaceReq {
  string name = 1;
  string path = 2;
  string device_finger_print = 3;
}

message ListWorkspaceReq {
  optional string name = 1;
  optional string owner = 2;
  optional string device_finger_print = 3;
}

message Workspace {
  string name = 1;
  int64 created_at = 2;
  int64 updated_at = 3;
  string owner = 4;
  string path = 5;
  string device_finger_print = 6;
}

message ListWorkspaceRsp {
  repeated Workspace workspaces = 1;
}

// Authentication & Token management
message LoginReq {
  string username = 1;
  string password = 2;
}

message LoginRsp {
  string access_token = 1; // JWT
  int64  expires_at   = 2; // unix seconds
}

message RegisterReq {
  string username = 1;
  string password = 2;
  string email    = 3;
}

message RegisterRsp {}

message TrackFilesIntoChangelistReq {
  string workspace_name = 1;
  // 若 changelist_id 为 0，则代表是默认 cl
  int64 changelist_id = 2;
  repeated string depot_paths = 3;
}

message UntrackFilesFromChangelistReq {
  string workspace_name = 1;
  // 若 changelist_id 为 0，则代表是默认 cl
  int64 changelist_id = 2;
  repeated string depot_paths = 3;
  optional bool all = 4;
}

message SubmitFilesInChangelistReq {
  string workspace_name = 1;
  // 若 changelist_id 为 0，则代表是默认 cl
  int64 changelist_id = 2;
  string description = 3;
}

enum SubmitChangelistResult {
  UNKNOWN = 0;
  SUCCESS = 1;
  FAILED = 2;
}

message SubmitFilesInChangelistRsp {
  int64 changelist_id = 1;
  SubmitChangelistResult result = 2;
}

message ListFilesInChangelistReq {
  string workspace_name = 1;
  // 若 changelist_id 为 0，则代表是默认 cl
  int64 changelist_id = 2;
}

message ListFilesInChangelistRsp {
  string workspace_name = 1;
  // 若 changelist_id 为 0，则代表是默认 cl
  int64 changelist_id = 2;
  repeated string depot_paths = 3;
}

service HiveService {
  rpc Greeting(GreetingReq) returns (NilRsp);
  rpc UpsertWorkspace(UpsertWorkspaceReq) returns (NilRsp);
  rpc ListWorkspaces(ListWorkspaceReq) returns (ListWorkspaceRsp);

  // Auth & Token management
  rpc Login(LoginReq) returns (LoginRsp);
  rpc Register(RegisterReq) returns (RegisterRsp);
  rpc TrackFilesIntoChangelist(TrackFilesIntoChangelistReq) returns (NilRsp);
  rpc UntrackFilesFromChangelist(UntrackFilesFromChangelistReq) returns (NilRsp);
  rpc ListFilesInChangelist(ListFilesInChangelistReq) returns (ListFilesInChangelistRsp);
  rpc SubmitFilesInDefaultChangelist(SubmitFilesInChangelistReq) returns (SubmitFilesInChangelistRsp);
}
