syntax = "proto3";
package hive_proto;

message BonjourReq {}

message BonjourRsp {
    int32 majorVersion = 1;
    int32 minorVersion = 2;
    string apiImplementation = 3;
    string platform = 4;
    string os = 5;
    string architecture = 6;
}

// Auth Starts
message RegisterReq {
    string username = 1;
    string password = 2;
}

message RegisterRsp {
    bool success = 1;
    string message = 2;
}

message LoginReq {
    string username = 1;
    string password = 2;
}

message LoginRsp {
    string accessToken = 1;
    int64 expiresAt = 2;
}
// Auth End

// Submit Start
message UploadFileChunkReq {
    string ticket = 1;
    // 可支持同时上传多个 file chunk
    int64 chunks_amount = 2;
    string chunk_hash = 3;
    int64 offset = 4;
    bytes content = 5;
    // 某个 file_chunk 的总大小，压缩算法处理后的，如果没有压缩算法那么和 uncompressed_size 应该是一致的
    int64 chunk_size = 6;
    // 本块使用的压缩方式，必须传入，目前可用字段是 "none" / "lz4"，当前算法是只支持了 none，所以 edge 可以先不压缩
    string compression = 7;
    // 解压后的原始大小（字节），用于校验
    uint32 uncompressed_size = 8;
}

message UploadFileChunkRsp {
    string ticket = 1;
    bool success = 2;
    string chunk_hash = 3;
    string message = 4;
    // 如果服务器端已经存在相同 chunk（基于 chunk_hash），则会返回 true
    bool already_exists = 5;
}

// 客户端可先询问服务器当前缺少哪些 chunk，从而只上传需要的部分
message CheckChunksReq {
    repeated string chunk_hashes = 1;
}

message CheckChunksRsp {
    // 服务器端当前不存在的 chunk_hash 列表
    repeated string missing_chunk_hashes = 1;
}

message FileChunk {
    // 文件 depot path
    string path = 1;
    repeated string binary_id = 2;
}

message SubmitReq {
    string ticket = 1;
    string description = 2;
    repeated FileChunk file_chunks = 3;
}

message FileToLock {
    string path = 1;
    // 期望在锁定时文件的代数
    optional int64 expected_file_generation = 2;
    // 期望在锁定时文件的版本
    optional int64 expected_file_revision = 3;
}

message LaunchSubmitReq {
    // 要锁定的文件
    repeated FileToLock files = 1;
}

message FileUnableToLock {
    string path = 1;
    string current_file_revision = 2;
    string expected_file_revision = 3;
    bool expected_file_not_exist = 4;
}

message LaunchSubmitRsp {
    string ticket = 1;
    // 如果有任何文件无法被锁定则返回 false
    bool success = 2;
    repeated FileUnableToLock file_unable_to_lock = 3;
}

message SubmitConflict {
    string path = 1;
    int64 expected_file_generation = 2;
    int64 expected_file_revision = 3;
    int64 current_file_generation = 4;
    int64 current_file_revision = 5;
}

message SubmitRsp {
    bool success = 1;
    // 如果成功，返回新建的 changelist ID 及提交时间
    int64 changelist_id = 2;
    int64 committed_at = 3;

    // 如果由于文件版本冲突导致提交失败，列出冲突详情
    repeated SubmitConflict conflicts = 4;

    // 如果在检查时发现任何文件包含的 chunk 尚未全部上传，也可以在这里返回其 chunk_id
    repeated string missing_chunks = 5;

    // 提交的各文件 depot path 到提交后的该文件最新 revision 的映射
    repeated FileRevision latest_revisions = 6;

    string message = 7;
}
// Submit End

message FileRevision {
    // 该文件的 depot path
    string path = 1;
    // 该文件的代数
    // 代数是指文件被删除又创建的次数
    // 例如，文件是第一次被创建则是第一代
    // 如果被删除后又创建那么这个文件就是第二代
    int64 generation = 2;
    // 该文件在当前代数下是第几个版本，注意：每次文件删除后重建这个 revision 会从 1 开始重新计数
    int64 revision = 3;
    // 该文件属于哪个 changelist
    int64 changelist_id = 4;
    // 目前还未支持压缩算法，后续这里可能会变复杂，会变成一个对象同时描述这个块的压缩算法，但是现在默认所有块都无压缩
    // 如果 binary_id 为空，则表示该 Revision 用于表示文件被删除。
    repeated string binary_id = 5;
    // 该文件的总大小（所有 chunk 大小之和）
    int64 size = 6;
    // 该文件 revision 的创建时间
    int64 revision_created_at = 7;
}

message GetFileTreeReq {
    // 获取目标位置的 depot tree 信息，常见的格式如下：
    // //a/b/c/... 获取这个目录下的所有文件信息
    // //a/b/c.txt 获取这个文件的信息
    // 目前先只支持上述操作
    string depot_wildcard = 1;
    // 获取到的目标位置的 depot tree 信息截止到哪个 changelist 前
    int64 changelist_id = 2;
}

message GetFileTreeRsp {
    // 获取得到的目标 depot tree 下的所有文件 Revision 信息
    // 值得注意的是，应该返回最接近请求中 changelist 的 revision
    repeated FileRevision file_revisions = 1;
}

message DownloadFileChunkReq {
    repeated string chunk_hashes = 1;
    int64 packetSize = 2; // 每个 stream 包的大小，单位 byte
}

// 目前，下载文件 Chunk 时，会将 Chunk 拆分为至多 4MB 的块进行传输以方便 gRPC 进行网络优化
message DownloadFileChunkResp {
    string chunk_hash = 1;
    int64 offset = 2;
    bytes content = 3;
    uint64 size = 4;
    // 本块使用的压缩方式，可选，例如 "none" / "lz4"，目前不支持压缩，所有 Chunk 都是 none
    string compression = 5;
    // 解压后的原始大小（字节），用于校验，目前不支持压缩，所以这个值应该和 size 一致
    uint32 uncompressed_size = 6;
}

service HiveService {
    rpc bonjour(BonjourReq) returns (BonjourRsp);

    rpc Login(LoginReq) returns (LoginRsp);
    rpc Register(RegisterReq) returns (RegisterRsp);

    rpc LaunchSubmit(LaunchSubmitReq) returns (LaunchSubmitRsp);
    rpc CheckChunks(CheckChunksReq) returns (CheckChunksRsp);
    rpc UploadFileChunk(stream UploadFileChunkReq) returns (stream UploadFileChunkRsp);
    rpc Submit(SubmitReq) returns (SubmitRsp);

    rpc GetFileTree(GetFileTreeReq) returns (GetFileTreeRsp);
    rpc DownloadFileChunk(DownloadFileChunkReq) returns (stream DownloadFileChunkResp);
}
