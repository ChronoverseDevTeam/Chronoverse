syntax = "proto3";
package daemon_proto;

message BonjourReq {}

message BonjourRsp {
  string daemonVersion = 1;
  int32 apiLevel = 2;
  string platform = 3;
  string os = 4;
  string architecture = 5;
}

message GetRuntimeConfigReq {}

message GetRuntimeConfigRsp {
  RuntimeConfigItem remote_addr = 1;
  RuntimeConfigItem editor = 2;
  RuntimeConfigItem user = 3;
}

message RuntimeConfigItem {
  string value = 1;
  string source = 2;
}

service SystemService {
  rpc Bonjour(BonjourReq) returns (BonjourRsp);
  rpc BonjourHive(BonjourReq) returns (BonjourRsp);
  rpc GetRuntimeConfig(GetRuntimeConfigReq) returns (GetRuntimeConfigRsp);
}

// Workspace management
message CreateWorkspaceReq {
  string workspace_name = 1;
  string workspace_root = 2;
  string workspace_mapping = 3;
}

message CreateWorkspaceRsp {}

message DeleteWorkspaceReq {
  string workspace_name = 1;
}

message DeleteWorkspaceRsp {}

message ListWorkspacesReq {}

message ListWorkspacesRsp {
  repeated string workspace_names = 1;
}

message DescribeWorkspaceReq {
  string workspace_name = 1;
}

message DescribeWorkspaceRsp {
  string workspace_name = 1;
  string workspace_path = 2;
  repeated string file_paths = 3;
}

service WorkspaceService {
  rpc CreateWorkspace(CreateWorkspaceReq) returns (CreateWorkspaceRsp);
  rpc DeleteWorkspace(DeleteWorkspaceReq) returns (DeleteWorkspaceRsp);
  rpc ListWorkspaces(ListWorkspacesReq) returns (ListWorkspacesRsp);
  rpc DescribeWorkspace(DescribeWorkspaceReq) returns (DescribeWorkspaceRsp);
}

// File operations
message AddReq {
  string workspace_name = 1;
  repeated string paths = 2;
}

message AddRsp {
  repeated string added_paths = 1;
}

message CheckoutReq {
  string workspace_name = 1;
  repeated string paths = 2;
}

message CheckoutRsp {
  repeated string checkouted_paths = 1;
}

message DeleteReq {
  string workspace_name = 1;
  repeated string paths = 2;
}

message DeleteRsp {
  repeated string deleted_paths = 1;
}

message SyncReq {
  string workspace_name = 1;
  repeated string paths = 2; // 可能是本地路径、工作区路径、或者 depot 路径
  bool force = 3;
}

// Sync 操作的总进度报告
message SyncProgress {
  oneof payload {
    // 第一次发送：用于初始化进度条的总信息
    SyncMetadata metadata = 1;
    // 后续发送：用于实时更新的单个文件进度
    SyncFileUpdate file_update = 2;
  }
}

message SyncFileMetadata {
  // 文件 depot path
  string path = 1;
  // 文件大小，以字节为单位
  int64 size = 2;
}

// 文件元数据信息（只发送一次）
message SyncMetadata {
  repeated SyncFileMetadata files = 1;
}

// 包含单个文件更新的信息（多次发送）
message SyncFileUpdate {
  // 文件 depot path
  string path = 1;
  // 已完成的字节数
  int64 bytes_completed_so_far = 2;
  // 提示信息
  string info = 3;
  // 警告信息
  string warning = 4;
}

message LockReq {
  string workspace_name = 1;
  repeated string paths = 2;
}

message LockRsp {
  repeated string locked_paths = 1;
}

message RevertReq {
  string workspace_name = 1;
  repeated string paths = 2;
}

message RevertRsp {
  repeated string reverted_paths = 1;
}

message SubmitReq {
  string workspace_name = 1;
  repeated string paths = 2;
  string description = 3;
}

message SubmitProgress {
  string path = 1;
  // 文件总字节数
  int64 size = 2;
  // 已完成的字节数
  int64 bytes_completed_so_far = 3;
  // 提示信息
  string info = 4;
  // 警告信息
  string warning = 5;
}

message ListActiveFilesReq {
  string workspace_name = 1;
  string path = 2; // 目录路径，可以是本地路径、工作区路径、或者 depot 路径
}

message ActiveFileInfo {
  string path = 1;
  string action = 2; // "add", "edit", "delete"
}

message ListActiveFilesRsp {
  repeated ActiveFileInfo active_files = 1;
}

service FileService {
  rpc Add(AddReq) returns (AddRsp);
  rpc Checkout(CheckoutReq) returns (CheckoutRsp);
  rpc Delete(DeleteReq) returns (DeleteRsp);
  rpc Sync(SyncReq) returns (stream SyncProgress);
  rpc Lock(LockReq) returns (LockRsp);
  rpc Revert(RevertReq) returns (RevertRsp);
  rpc Submit(SubmitReq) returns (stream SubmitProgress);
  rpc ListActiveFiles(ListActiveFilesReq) returns (ListActiveFilesRsp);
}

// Local Changelist management
message CreateChangelistReq {
  string workspace_name = 1;
  string description = 2;
}

message CreateChangelistRsp {
  string changelist_id = 1;
}

message DeleteChangelistReq {
  string workspace_name = 1;
  string changelist_id = 2;
}

message DeleteChangelistRsp {}

message ListChangelistsReq {
  string workspace_name = 1;
}

message ListChangelistsRsp {
  repeated ChangelistInfo changelists = 1;
}

message ChangelistInfo {
  string id = 1;
  string description = 2;
  int32 file_count = 3;
  string status = 4;
}

message DescribeChangelistReq {
  string changelist_id = 1;
  bool list_files = 2;
}

message DescribeChangelistRsp {
  string workspace_name = 1;
  ChangelistInfo changelist = 2;
  repeated string file_paths = 3;
}

message AppendChangelistReq {
  string workspace_name = 1;
  string changelist_id = 2;
  repeated string paths = 3;
}

message AppendChangelistRsp {}

message SubmitChangelistReq {
  string workspace_name = 1;
  string changelist_id = 2;
}

service ChangelistService {
  rpc CreateChangelist(CreateChangelistReq) returns (CreateChangelistRsp);
  rpc DeleteChangelist(DeleteChangelistReq) returns (DeleteChangelistRsp);
  rpc ListChangelists(ListChangelistsReq) returns (ListChangelistsRsp);
  rpc DescribeChangelist(DescribeChangelistReq) returns (DescribeChangelistRsp);
  rpc AppendChangelist(AppendChangelistReq) returns (AppendChangelistRsp);
  rpc SubmitChangelist(SubmitChangelistReq) returns (stream SubmitProgress);
}

// Debug & Simulation
message TransferBlueprintReq {
  int32 worker_count = 1;
}

message TransferBlueprintRsp {
  string worker_id = 1;
  string type = 2; // "progress", "warning", "error"
  string message = 3;
  int32 retry_count = 4;
}

message TransferBlueprintAsyncStartReq {
  int32 worker_count = 1;
}

message TransferBlueprintAsyncStartRsp {
  string job_id = 1;
}

message TransferBlueprintAsyncCheckReq {
  string job_id = 1;
}

message TransferBlueprintAsyncCheckRsp {
  string job_status = 1;
  repeated TransferBlueprintRsp messages = 2;
}

message CancelJobReq {
  string job_id = 1;
}

message CancelJobRsp {}

service DebugService {
  rpc TransferBlueprint(TransferBlueprintReq) returns (stream TransferBlueprintRsp);
  rpc TransferBlueprintAsyncStart(TransferBlueprintAsyncStartReq) returns (TransferBlueprintAsyncStartRsp);
  rpc TransferBlueprintAsyncCheck(TransferBlueprintAsyncCheckReq) returns (TransferBlueprintAsyncCheckRsp);
  rpc CancelJob(CancelJobReq) returns (CancelJobRsp);
}
